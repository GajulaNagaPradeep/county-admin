DOCKER_GROUP = 'cwds'
DOCKER_IMAGE = 'cap'

node('int') {
  def app
    try {
      deleteDir()
        stage('Checkout') {
          checkout scm
        }
      stage('Integration Acceptance Test') {
       sh "docker-compose up -d --build county-admin-test"
       sh "docker-compose exec -T --env COGNITO_USERNAME='${COG_USER}' --env COGNITO_PASSWORD='${COG_PASS}' --env COUNTY_AUTHORIZATION_ENABLED=true --env COUNTY_ADMIN_WEB_BASE_URL=https://web.integration.cwds.io/cap county-admin-test bundle exec rspec spec/acceptance"
      }
    } catch(Exception e) {
      currentBuild.result = "FAILURE"
        throw e
    } finally {
      sh "docker-compose down"
      cleanWs()
    }
}
